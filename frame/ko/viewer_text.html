<!DOCTYPE html>
<html lang="ko">
<body>
<div id="mainCont" onclick="closeAllOption();"></div>
<div id="viewProgress"></div>
<div id="viewProgressInfo" onclick="openProgressMenu();"></div>
<div id="view-text-progress-option">
    <div onclick="scrollToTop();">맨 위로</div>
    <div onclick="scrollToBottom();">맨 아래로</div>
    <div>특정 줄로 이동</div>
    <div>북마크</div>
</div>
</body>
<script>
    let nowScroll, loadBeginEl, loadEndEl, chunkSize = 500, fileList;
    let openedMD5;
    let highlightObj;

    async function saveScroll() {
        await setting.set('scroll_' + openedMD5, nowScroll);
    }

    setInterval(saveScroll, 500);

    async function scrollHandler() {
        document.getElementById('sideMenu').classList.remove('sideMenu-open');
        if (nowScroll < 0) nowScroll = 0;
        if (nowScroll >= fileList.length) nowScroll = fileList.length - 1;
        try {

            while (document.getElementById('body_' + nowScroll).offsetTop <= document.getElementById('mainCont').offsetTop + document.getElementById('mainCont').scrollTop && nowScroll < loadEndEl) ++nowScroll;
            while (document.getElementById('body_' + nowScroll).offsetTop > document.getElementById('mainCont').offsetTop + document.getElementById('mainCont').scrollTop && nowScroll > loadBeginEl) --nowScroll;
            while (loadBeginEl + chunkSize / 2 < nowScroll) {
                document.getElementById('body_' + loadBeginEl).remove();
                ++loadBeginEl;
            }
            while (loadEndEl - chunkSize / 2 > nowScroll) {
                --loadEndEl;
                document.getElementById('body_' + loadEndEl).remove();
            }
            while (loadBeginEl + chunkSize / 2 > nowScroll && loadBeginEl > 0) {
                --loadBeginEl;
                let newNode = document.createElement("p");
                newNode.innerText = fileList[loadBeginEl];
                if (highlightObj.hasOwnProperty(loadBeginEl)) newNode.className = "body-common body-highlight";
                else newNode.className = "body-common";
                newNode.id = 'body_' + loadBeginEl;
                document.getElementById('mainCont').prepend(newNode);
            }
            while (loadEndEl - chunkSize / 2 < nowScroll && fileList.length - 1 > loadEndEl) {
                let newNode = document.createElement("p");
                newNode.innerText = fileList[loadEndEl];
                if (highlightObj.hasOwnProperty(loadEndEl)) newNode.className = "body-common body-highlight";
                else newNode.className = "body-common";
                newNode.id = 'body_' + loadEndEl;
                document.getElementById('mainCont').append(newNode);
                ++loadEndEl;
            }
        } catch (e) {

        }
        try {
            document.getElementById('body_' + (fileList.length - 2)).style.marginBottom = '15px';
        } catch (e) {

        }
        document.getElementById('viewProgress').style.width = (nowScroll + 1) / fileList.length * 100 + 'vw';
        document.getElementById('viewProgressInfo').innerText = Math.floor((nowScroll + 1) / fileList.length * 100) + '% (' + (nowScroll + 1).toString() + '/' + fileList.length.toString() + ')';
    }

    function resizeHandler() {
        let tmpScroll = nowScroll;
        setTimeout(() => {
            nowScroll = tmpScroll;
            document.getElementById('mainCont').scrollTop = document.getElementById('body_' + nowScroll).offsetTop - mainCont.offsetTop - 10;
        }, 200);
    }

    async function viewer_text_init() {
        const mainCont = document.getElementById('mainCont');
        let openFileName = await setting.get('file');
        highlightObj = await setting.get('highlight_' + md5File);
        if (!highlightObj) highlightObj = Object();
        mainCont.innerHTML = "";
        openedMD5 = md5File.sync(openFileName).toString();
        changeTitle('viewIt - ' + (openFileName).split('\\').slice(-1)[0].split('.').slice(0, -1).join('.'));
        setTimeout(async () => {
            chardet.detectFile(openFileName, {sampleSize: 500}).then(async encoding => {
                let input = fs.readFileSync(openFileName, {encoding: "binary"});
                let data = iconv.decode(input, encoding);
                fileList = data.toString().split('\n');
                fileList.push('');
                nowScroll = await setting.get('scroll_' + openedMD5);
                if (!nowScroll) {
                    nowScroll = 0;
                    await setting.set('scroll_' + openedMD5, 0);
                }
                loadBeginEl = nowScroll - chunkSize / 2;
                if (loadBeginEl < 0) loadBeginEl = 0;
                if (loadBeginEl > fileList.length - chunkSize - 1) loadBeginEl = fileList.length - chunkSize - 1;
                loadEndEl = loadBeginEl + chunkSize;
                for (let i = loadBeginEl; i < loadEndEl; ++i) {
                    let newNode = document.createElement("p");
                    newNode.innerText = fileList[i];
                    if (highlightObj.hasOwnProperty(i)) newNode.className = "body-common body-highlight";
                    else newNode.className = "body-common";
                    newNode.id = 'body_' + i;
                    newNode.onclick = highlight;
                    mainCont.appendChild(newNode);
                }
                mainCont.scrollTop = document.getElementById('body_' + nowScroll).offsetTop - mainCont.offsetTop - 10;
                try {
                    document.getElementById('body_' + (fileList.length - 2)).style.marginBottom = '15px';
                } catch (e) {

                }
                mainCont.addEventListener('scroll', scrollHandler);
                window.addEventListener('resize', resizeHandler);
                closeToast();
                await scrollHandler();
            });
        }, 0);
    }

    function viewer_text_exit() {
        document.getElementById('mainCont').removeEventListener('scroll', scrollHandler);
        window.removeEventListener('resize', resizeHandler);
        fileList = [];
    }

    function openProgressMenu() {
        document.getElementById('view-text-progress-option').classList.remove('close');
        document.getElementById('view-text-progress-option').classList.add('open');
    }

    function closeAllOption() {
        document.getElementById('sideMenu').classList.remove('sideMenu-open');
        if (document.getElementById('view-text-progress-option').classList.contains('open')) {
            document.getElementById('view-text-progress-option').classList.add('close');
            setTimeout(() => {
                document.getElementById('view-text-progress-option').classList.remove('open');
                document.getElementById('view-text-progress-option').classList.remove('close');
            }, 150);
        }
    }

    async function scrollToTop() {
        showToast('불러오는 중...', '', '', true);
        nowScroll = 0;
        viewer_text_exit();
        await setting.set('scroll_' + openedMD5, 0);
        await viewer_text_init();
        closeAllOption();
        await scrollHandler();
    }

    async function scrollToBottom() {
        showToast('불러오는 중...', '', '', true);
        nowScroll = fileList.length - 3;
        viewer_text_exit();
        await setting.set('scroll_' + openedMD5, nowScroll);
        await viewer_text_init();
        closeAllOption();
        await scrollHandler();
    }

    async function highlight(e) {
        if (document.getElementById('view-text-progress-option').classList.contains('open')) return;
        el = e.toElement;
        let id = el.id.substr(5);
        if (highlightObj.hasOwnProperty(id)) {
            delete highlightObj[id]
            document.getElementById('body_' + id).classList.remove('body-highlight');
        } else {
            highlightObj[id] = true;
            document.getElementById('body_' + id).classList.add('body-highlight');
        }
        await setting.set('highlight_' + md5File, highlightObj);
    }
</script>
</html>